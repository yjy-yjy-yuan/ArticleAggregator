<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå­¦ç”Ÿæ–‡ç« èšåˆå™¨ - ç²¾é€‰æ–‡ç« åº“</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>ğŸ“ AIå­¦ç”Ÿæ–‡ç« èšåˆå™¨</h1>
        <p>ç²¾é€‰AIå­¦æœ¯æ–‡ç« ï¼Œæ¯æ—¥æ›´æ–°</p>
    </header>

    <main>
        <div class="controls">
            <button id="refreshBtn" onclick="loadBatches()">ğŸ”„ åˆ·æ–°</button>
            <button id="fetchBtn" onclick="triggerFetch()">ğŸ“¥ æŠ“å–æ–°æ–‡ç« </button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <p>â³ åŠ è½½ä¸­...</p>
        </div>

        <div id="batchesContainer" class="batches-grid">
            <!-- æ‰¹æ¬¡å¡ç‰‡å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <p>ğŸ“­ æš‚æ— æ–‡ç« æ‰¹æ¬¡</p>
            <p>ç‚¹å‡»"æŠ“å–æ–°æ–‡ç« "å¼€å§‹è·å–å†…å®¹</p>
        </div>
    </main>

    <script>
        const API_BASE = 'http://localhost:8765';

        // é¡µé¢åŠ è½½æ—¶è·å–æ‰¹æ¬¡åˆ—è¡¨
        window.onload = function() {
            loadBatches();
        };

        // åŠ è½½æ‰¹æ¬¡åˆ—è¡¨
        async function loadBatches() {
            const container = document.getElementById('batchesContainer');
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('emptyState');

            loading.style.display = 'block';
            container.innerHTML = '';
            emptyState.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/batches`);
                const batches = await response.json();

                loading.style.display = 'none';

                if (batches.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                batches.forEach((batch, index) => {
                    const card = createBatchCard(batch, index);
                    container.appendChild(card);
                });

            } catch (error) {
                loading.style.display = 'none';
                container.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åˆ›å»ºæ‰¹æ¬¡å¡ç‰‡
        function createBatchCard(batch, index) {
            const card = document.createElement('div');
            card.className = 'batch-card';
            card.onclick = () => viewBatch(batch.batch_date);

            const batchNumber = index + 1;
            const date = new Date(batch.batch_date);
            const dateStr = date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            card.innerHTML = `
                <div class="batch-header">
                    <h2>ç²¾é€‰æ–‡ç«  ç¬¬${batchNumber}æœŸ</h2>
                    <span class="batch-badge">${batch.article_count}ç¯‡</span>
                </div>
                <div class="batch-info">
                    <p class="batch-date">ğŸ“… ${dateStr}</p>
                    <p class="batch-subtitle">ç¬¬${batchNumber}æ¬¡æ‹‰å–</p>
                </div>
                <div class="batch-footer">
                    <span class="view-link">æŸ¥çœ‹æ–‡ç«  â†’</span>
                </div>
            `;

            return card;
        }

        // æŸ¥çœ‹æ‰¹æ¬¡è¯¦æƒ…
        function viewBatch(batchDate) {
            window.location.href = `batch.html?date=${batchDate}`;
        }

        // è§¦å‘æŠ“å–
        async function triggerFetch() {
            const btn = document.getElementById('fetchBtn');
            btn.disabled = true;
            btn.textContent = 'â³ æŠ“å–ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/api/rss/fetch`, {
                    method: 'POST'
                });
                const result = await response.json();

                alert('âœ… æŠ“å–å·²å¼€å§‹ï¼è¯·ç­‰å¾…å‡ åˆ†é’Ÿååˆ·æ–°é¡µé¢æŸ¥çœ‹æ–°æ–‡ç« ã€‚');

                // 5ç§’åè‡ªåŠ¨åˆ·æ–°
                setTimeout(() => {
                    loadBatches();
                    btn.disabled = false;
                    btn.textContent = 'ğŸ“¥ æŠ“å–æ–°æ–‡ç« ';
                }, 5000);

            } catch (error) {
                alert('âŒ æŠ“å–å¤±è´¥: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'ğŸ“¥ æŠ“å–æ–°æ–‡ç« ';
            }
        }
    </script>
</body>
</html>
